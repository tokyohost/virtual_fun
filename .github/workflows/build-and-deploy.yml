name: Build and Publish DKMS Module

on:
  push:
    branches:
      - main  # 只在主分支推送时触发
  pull_request:
    branches:
      - main  # 也可以在 PR 时触发

jobs:
  build:
    runs-on: ubuntu-latest  # 使用最新的 Ubuntu 环境

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dkms build-essential debhelper fakeroot

      # Step 3: Prepare DKMS environment
      - name: Prepare DKMS module
        run: |
          mkdir -p /usr/src/virtual-fan-1.0
          cp virtual_fan.c /usr/src/virtual-fan-1.0/
          cd /usr/src/virtual-fan-1.0
          echo "Source: virtual-fan" > debian/control
          echo "Maintainer: <Your Name>" >> debian/control
          echo "Build-Depends: debhelper, dkms" >> debian/control
          echo "Standards-Version: 3.9.8" >> debian/control
          echo "Package: virtual-fan" >> debian/control
          mkdir debian
          touch debian/changelog
          touch debian/rules
          
          # Your DKMS setup (dkms.conf file)
          echo "PACKAGE_NAME=\"virtual-fan\"" > debian/dkms.conf
          echo "PACKAGE_VERSION=\"1.0\"" >> debian/dkms.conf
          echo "BUILT_MODULE_NAME[0]=\"virtual_fan\"" >> debian/dkms.conf
          echo "DEST_MODULE_LOCATION[0]=\"/extra\"" >> debian/dkms.conf
          echo "AUTOINSTALL=\"yes\"" >> debian/dkms.conf

      # Step 4: Build DKMS module
      - name: Build DKMS module
        run: |
          sudo dkms add -m virtual-fan -v 1.0
          sudo dkms build -m virtual-fan -v 1.0

      # Step 5: Package the DKMS module into a .deb file
      - name: Create .deb package
        run: |
          sudo debuild -us -uc

      # Step 6: Upload .deb artifact
      - name: Upload .deb artifact
        uses: actions/upload-artifact@v2
        with:
          name: virtual-fan-deb
          path: *.deb
          
      # Step 7: Clean up
      - name: Clean up
        run: |
          sudo dkms remove -m virtual-fan -v 1.0 --all
          sudo rm -rf /usr/src/virtual-fan-1.0

